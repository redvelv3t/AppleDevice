<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wallpaper Picker</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="light dark">
</head>
<body oncontextmenu="return false">
  <main class="container" aria-live="polite">
    <div class="thumbCard" id="thumbCard" hidden aria-hidden="true">
      <div class="thumbnail" id="thumbnail" ondragstart="return false"></div>
    </div>

    <p class="caption" id="caption" hidden>Detecting deviceâ€¦</p>

    <button id="actionBtn" class="btn btn-primary">
      Get wallpaper
    </button>

    <div class="actions-row" id="auxActions" hidden>
      <button id="copyBtn" class="btn btn-ghost">Copy my screen size</button>
      <a id="sendLink" class="btn btn-ghost" href="#" rel="noopener">Send screen size</a>
    </div>

    <p class="specs" id="specs" hidden></p>

    <footer class="footer">v1.0.1 â€¢ 2025â€‘08â€‘12 â€¢ iPhoneâ€‘only</footer>
  </main>

<script>
/* ------------------ helpers ------------------ */
function isIPadLike(ua, platform, maxTouch) {
  const looksLikeMac = /Macintosh/i.test(ua) || /Mac/i.test(platform || "");
  return looksLikeMac && (maxTouch || 0) > 1; // iPadOS posing as Mac
}
function getIOSVersion(ua) {
  const m1 = /OS (\d+)[._](\d+)(?:[._](\d+))?/.exec(ua);
  if (m1) return [m1[1], m1[2], m1[3]].filter(Boolean).join(".");
  const m2 = /Version\/(\d+)\.(\d+)(?:\.(\d+))?/.exec(ua);
  if (m2 && /Safari/i.test(ua)) return [m2[1], m2[2], m2[3]].filter(Boolean).join(".");
  return null;
}
function normalizeWH(w, h) {
  const min = Math.min(w, h), max = Math.max(w, h);
  return { w:min, h:max };
}
function approxEqual(a, b, tol=1) { return Math.abs(a-b) <= tol; }

/* ------------------ detection ------------------ */
function detectAppleThing() {
  const ua = navigator.userAgent || "";
  const platform = (navigator.platform || (navigator.userAgentData && navigator.userAgentData.platform)) || "";
  const maxTouch = navigator.maxTouchPoints || 0;

  let type = null;
  if (/iPhone/i.test(ua)) type = "iPhone";
  else if (/iPad/i.test(ua)) type = "iPad";
  else if (isIPadLike(ua, platform, maxTouch)) type = "iPad";
  else type = "Other";

  const osVersion = getIOSVersion(ua) || null;

  const dpr = window.devicePixelRatio || 1;
  const { w, h } = normalizeWH(window.screen.width, window.screen.height);
  const nativeW = Math.round(w * dpr), nativeH = Math.round(h * dpr);

  return { type, osVersion, w, h, dpr, nativeW, nativeH, ua, maxTouch };
}

/* ------------------ iPhone family map ------------------ */
const FAMILY_MAP = [
  { w:320, h:568, dpr:2,  key:"iphone-4.0@2x.jpg",           label:'iPhone 4.0â€³ family' },
  { w:375, h:667, dpr:2,  key:"iphone-4.7@2x.jpg",           label:'iPhone 4.7â€³ family' },
  { w:414, h:736, dpr:3,  key:"iphone-5.5@3x.jpg",           label:'iPhone 5.5â€³ Plus family' },
  { w:375, h:812, dpr:3,  key:"iphone-5.8@3x.jpg",           label:'iPhone 5.8â€³ family' },
  { w:414, h:896, dpr:2,  key:"iphone-6.1-old@2x.jpg",       label:'iPhone 6.1â€³ (XR/11) family' },
  { w:414, h:896, dpr:3,  key:"iphone-6.5@3x.jpg",           label:'iPhone 6.5â€³ family' },
  { w:360, h:780, dpr:3,  key:"iphone-5.4@3x.jpg",           label:'iPhone 5.4â€³ mini family' },
  { w:390, h:844, dpr:3,  key:"iphone-6.1@3x.jpg",           label:'iPhone 6.1â€³ (12/13/14/15/16) family' },
  { w:428, h:926, dpr:3,  key:"iphone-6.7@3x.jpg",           label:'iPhone 6.7â€³ (12â€“16 Plus/Pro Max) family' },
  { w:393, h:852, dpr:3,  key:"iphone-6.1-pro@3x.jpg",       label:'iPhone 6.1â€³ Pro family' },
  { w:430, h:932, dpr:3,  key:"iphone-6.7-pro-max@3x.jpg",   label:'iPhone 6.7â€³ Pro Max family' },
];
function matchIPhoneFamily(w, h, dpr) {
  for (const f of FAMILY_MAP) {
    if (approxEqual(f.w, w) && approxEqual(f.h, h) && approxEqual(f.dpr, dpr, 0.25)) {
      return f;
    }
  }
  return null;
}

/* ------------------ UI wiring ------------------ */
const thumbCard = document.getElementById('thumbCard');
const captionEl = document.getElementById('caption');
const btn = document.getElementById('actionBtn');
const specsEl = document.getElementById('specs');
const aux = document.getElementById('auxActions');
const copyBtn = document.getElementById('copyBtn');
const sendLink = document.getElementById('sendLink');

let hasDetected = false;
let currentHref = null;

function setButton(label, href, disabled=false) {
  btn.textContent = label;
  currentHref = href || null;
  btn.disabled = !!disabled;
}

function makeIssueURL(payload) {
  const base = 'https://github.com/your-user/your-repo/issues/new';
  const title = encodeURIComponent(`Add support: ${payload.w}Ã—${payload.h} CSS, DPR ${payload.dpr}`);
  const body = encodeURIComponent(
`Device type guess: ${payload.type}
CSS size: ${payload.w}Ã—${payload.h}
Native size: ${payload.nativeW}Ã—${payload.nativeH}
DPR: ${payload.dpr}
iOS/iPadOS: ${payload.osVersion || 'unknown'}
UA: ${payload.ua}
maxTouchPoints: ${payload.maxTouch}
Page version: v1.0.1 (2025-08-12)`
  );
  return `${base}?title=${title}&body=${body}`;
}

function doDetectionAndReveal() {
  const info = detectAppleThing();
  const cssLabel = `${info.w}Ã—${info.h} CSS`;
  const nativeLabel = `${info.nativeW}Ã—${info.nativeH} px`;
  const dprLabel = `DPR ${info.dpr}`;
  const specsStr = `${cssLabel} â€¢ ${nativeLabel} â€¢ ${dprLabel}${info.osVersion ? ` â€¢ iOS/iPadOS ${info.osVersion}` : ''}`;

  // reveal UI bits now
  thumbCard.hidden = false;
  captionEl.hidden = false;

  if (info.type === 'iPhone') {
    const fam = matchIPhoneFamily(info.w, info.h, info.dpr);
    specsEl.hidden = false;
    specsEl.textContent = specsStr;

    if (fam) {
      captionEl.textContent = `Detected: ${fam.label}`;
      setButton('Download wallpaper', `wallpaper/${fam.key}`, false);
      aux.hidden = true; // Copy/Send ONLY when not detected
    } else {
      captionEl.textContent = 'Could not identify device';
      setButton('Use original wallpaper', 'wallpaper/wallpaper-master.jpg', false);
      aux.hidden = false; // show helpers ONLY now
      const clip = `iPhone: unknown â€¢ ${cssLabel} â€¢ ${nativeLabel} â€¢ ${dprLabel} â€¢ UA: ${info.ua}`;
      copyBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(clip);
          copyBtn.textContent = 'Copied!';
          setTimeout(()=>copyBtn.textContent='Copy my screen size', 1500);
        } catch {
          copyBtn.textContent = 'Copy failed';
          setTimeout(()=>copyBtn.textContent='Copy my screen size', 1500);
        }
      };
      sendLink.href = makeIssueURL(info);
    }
  } else if (info.type === 'iPad') {
    captionEl.textContent = 'iPad support coming soon ðŸ‘€';
    setButton('iPad not supported yet', null, true);
    specsEl.hidden = true;
    aux.hidden = true; // never show on iPad
  } else {
    captionEl.textContent = 'This tool is for iPhone. Desktop support coming soon.';
    setButton('Desktop not supported yet', null, true);
    specsEl.hidden = true;
    aux.hidden = true; // never show on desktop
  }
}

btn.addEventListener('click', () => {
  if (!hasDetected) {
    hasDetected = true;
    doDetectionAndReveal(); // first tap: detect & reveal UI
  } else if (currentHref) {
    // subsequent taps: go to target if available
    window.location.href = currentHref;
  }
});
</script>
</body>
</html>
